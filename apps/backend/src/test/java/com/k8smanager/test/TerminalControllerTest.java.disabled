package com.k8smanager.test;

import com.k8smanager.common.response.ApiResponse;
import com.k8smanager.controller.TerminalController;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.ArgumentMatchers.isA;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class TerminalControllerTest extends BaseTest {

    @Mock
    private io.fabric8.kubernetes.client.KubernetesClient kubernetesClient;

    @InjectMocks
    private TerminalController terminalController;

    @BeforeEach
    @Override
    void setUp() {
        super.setUp();
    }

    @Test
    void testConnectTerminal_Success_ShouldReturnSessionId() {
        // Given
        String namespace = "test-ns";
        String podName = "test-pod";
        String container = "test-container";
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        when(kubernetesClient.pods().inNamespace(eq(namespace)))
                .thenReturn(new io.fabric8.kubernetes.api.model.PodList());

        // When
        ResponseEntity<ApiResponse<com.k8smanager.controller.SessionInfo>> response =
                terminalController.connectTerminal(namespace, podName, container, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        assertThat(response.getBody().data().sessionId()).isNotEmpty();
        assertThat(response.getBody().data().namespace()).isEqualTo(namespace);
        assertThat(response.getBody().data().podName()).isEqualTo(podName);
        assertThat(response.getBody().data().container()).isEqualTo(container);

        verify(kubernetesClient, times(1)).pods().inNamespace(eq(namespace));
    }

    @Test
    void testConnectTerminal_SessionLimitExceeded_ShouldReturn429() {
        // Given
        String namespace = "test-ns";
        String podName = "test-pod";
        String container = "test-container";

        // Simulate 5 active sessions (limit is 5)
        for (int i = 0; i < 5; i++) {
            terminalController.registerSession("session-" + i, createMockExecWatch());
        }

        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        // When
        ResponseEntity<ApiResponse<com.k8smanager.controller.SessionInfo>> response =
                terminalController.connectTerminal(namespace, podName, container, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.TOO_MANY_REQUESTS);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isFalse();
        assertThat(response.getBody().error().errorCode()).isEqualTo("TERMINAL_SESSION_LIMIT_EXCEEDED");
    }

    @Test
    void testGetActiveSessions_ShouldReturnUserSessions() {
        // Given
        for (int i = 0; i < 3; i++) {
            terminalController.registerSession("session-" + i, createMockExecWatch());
        }

        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        // When
        ResponseEntity<ApiResponse<Map<String, com.k8smanager.controller.SessionInfo>>> response =
                terminalController.getActiveSessions(authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        assertThat(response.getBody().data()).isNotNull();
        assertThat(response.getBody().data()).hasSize(3);
    }

    @Test
    void testResizeTerminal_Success_ShouldResizeWindow() {
        // Given
        String sessionId = "test-session-id";
        com.k8smanager.controller.ResizeRequest resizeRequest = new com.k8smanager.controller.ResizeRequest(24, 80);
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));
        io.fabric8.kubernetes.client.dsl.NonClosingExecWatch mockWatch = createMockExecWatch();

        terminalController.registerSession(sessionId, mockWatch);

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.resizeTerminal(sessionId, resizeRequest, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        verify(mockWatch).getInput().write(isA(byte[].class));
        verify(mockWatch).getInput().flush();
    }

    @Test
    void testResizeTerminal_SessionNotFound_ShouldReturn404() {
        // Given
        String sessionId = "non-existent-session";
        com.k8smanager.controller.ResizeRequest resizeRequest = new com.k8smanager.controller.ResizeRequest(24, 80);
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.resizeTerminal(sessionId, resizeRequest, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isFalse();
        assertThat(response.getBody().error().errorCode()).isEqualTo("SESSION_NOT_FOUND");
    }

    @Test
    void testExecuteCommand_Success_ShouldExecuteCommand() {
        // Given
        String sessionId = "test-session-id";
        com.k8smanager.controller.CommandRequest commandRequest = new com.k8smanager.controller.CommandRequest("ls -la");
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));
        io.fabric8.kubernetes.client.dsl.NonClosingExecWatch mockWatch = createMockExecWatch();

        terminalController.registerSession(sessionId, mockWatch);

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.executeCommand(sessionId, commandRequest, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        verify(mockWatch).getInput().write(isA(byte[].class));
        verify(mockWatch).getInput().flush();
    }

    @Test
    void testExecuteCommand_SessionNotFound_ShouldReturn404() {
        // Given
        String sessionId = "non-existent-session";
        com.k8smanager.controller.CommandRequest commandRequest = new com.k8smanager.controller.CommandRequest("ls -la");
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.executeCommand(sessionId, commandRequest, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isFalse();
        assertThat(response.getBody().error().errorCode()).isEqualTo("SESSION_NOT_FOUND");
    }

    @Test
    void testInterruptTerminal_Success_ShouldSendInterruptSignal() {
        // Given
        String sessionId = "test-session-id";
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));
        io.fabric8.kubernetes.client.dsl.NonClosingExecWatch mockWatch = createMockExecWatch();

        terminalController.registerSession(sessionId, mockWatch);

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.interruptTerminal(sessionId, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        verify(mockWatch).getInput().write(isA(byte[].class));
        verify(mockWatch).getInput().flush();
    }

    @Test
    void testCloseTerminal_Success_ShouldCloseSession() {
        // Given
        String sessionId = "test-session-id";
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));
        io.fabric8.kubernetes.client.dsl.NonClosingExecWatch mockWatch = createMockExecWatch();

        terminalController.registerSession(sessionId, mockWatch);

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.closeTerminal(sessionId, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isTrue();
        verify(mockWatch).close();
    }

    @Test
    void testCloseTerminal_SessionNotFound_ShouldReturn404() {
        // Given
        String sessionId = "non-existent-session";
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                "test-user", null, List.of(new SimpleGrantedAuthority("EXEC", "POD")));

        // When
        ResponseEntity<ApiResponse<Void>> response =
                terminalController.closeTerminal(sessionId, authToken);

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().success()).isFalse();
        assertThat(response.getBody().error().errorCode()).isEqualTo("SESSION_NOT_FOUND");
    }

    @Test
    void testIsSessionLimitReached_ShouldReturnTrueWhenLimitReached() {
        // Given
        for (int i = 0; i < 5; i++) {
            terminalController.registerSession("session-" + i, createMockExecWatch());
        }

        // When
        boolean limitReached = terminalController.isSessionLimitReached();

        // Then
        assertThat(limitReached).isTrue();
    }

    @Test
    void testIsSessionLimitReached_ShouldReturnFalseWhenBelowLimit() {
        // Given
        terminalController.registerSession("session-1", createMockExecWatch());

        // When
        boolean limitReached = terminalController.isSessionLimitReached();

        // Then
        assertThat(limitReached).isFalse();
    }

    @Test
    void testGenerateSessionId_ShouldReturnUniqueIds() {
        // Given
        String sessionId1 = terminalController.generateSessionId("ns1", "pod1", "container1");
        String sessionId2 = terminalController.generateSessionId("ns1", "pod1", "container1");
        String sessionId3 = terminalController.generateSessionId("ns2", "pod2", "container2");

        // When - call twice with same params
        // Then
        assertThat(sessionId1).isNotEqualTo(sessionId2); // Different timestamps
        assertThat(sessionId1).isNotEqualTo(sessionId3); // Different timestamps
    }

    // Helper method to create mock exec watch
    private io.fabric8.kubernetes.client.dsl.NonClosingExecWatch createMockExecWatch() {
        return new io.fabric8.kubernetes.client.dsl.NonClosingExecWatch() {
            @Override
            public java.io.InputStream getInputStream() {
                return new java.io.ByteArrayInputStream(new byte[0]);
            }

            @Override
            public java.io.OutputStream getOutputStream() {
                return new java.io.ByteArrayOutputStream();
            }

            @Override
            public void write(byte[] b) throws java.io.IOException {
                // No-op for tests
            }

            @Override
            public void flush() throws java.io.IOException {
                // No-op for tests
            }

            @Override
            public void close() throws java.io.IOException {
                // No-op for tests
            }

            @Override
            public boolean isClosing() {
                return false;
            }
        };
    }
}
